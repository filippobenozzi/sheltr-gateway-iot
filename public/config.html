<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AlgoDomo Config</title>
<style>body{font:13px/1.3 system-ui,-apple-system,sans-serif;margin:10px;background:#f6f7f8;color:#111}h1{font-size:17px;margin:0 0 8px}.row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}label{display:flex;flex-direction:column;gap:2px;font-size:12px}input,select,button{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}input,select{border:1px solid #b8bec6;border-radius:6px;padding:6px;background:#fff}button{border:1px solid #4b5563;background:#fff;border-radius:6px;padding:6px 9px;cursor:pointer}button:hover{background:#eef2f7}button:disabled{opacity:.6;cursor:not-allowed}.box{background:#fff;border:1px solid #c9ced6;border-radius:8px;padding:10px;margin-top:8px}.small{font-size:12px;color:#444;margin:2px 0}.board{border:1px solid #d6dae0;border-radius:8px;padding:8px;margin:8px 0;background:#fafbfd}.board h2{font-size:14px;margin:0 0 6px}.channels{border-top:1px dashed #d2d7de;margin-top:6px;padding-top:6px}.ch{display:flex;align-items:center;gap:8px;margin:4px 0}.ch span{min-width:56px;font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#444}.ch input{min-width:130px}.ch .nm{flex:1}.ch .rm{width:120px}#msg,#sys{white-space:pre-wrap;font-size:12px;background:#fff;border:1px solid #c9ced6;border-radius:6px;padding:8px;min-height:22px}.hidden{display:none}</style>
</head>
<body>
<h1>Programmazione Schede</h1>
<div class="box">
<div class="row">
<label>Porta seriale<input id="serialPort" value="/dev/ttyS0"></label>
<label>Baudrate<input id="baudrate" type="number" value="9600"></label>
<label>Timeout ms<input id="timeout" type="number" value="1200"></label>
<label>Nome controllo<input id="displayName" value="Controllo Casa"></label>
<label>Token API GET<input id="token"></label>
</div>
<div class="row">
<button id="reload">Ricarica</button>
<button id="addBoard">Aggiungi scheda</button>
<button id="save">Salva</button>
<button id="downloadJson">Scarica JSON</button>
<button id="uploadJson">Carica JSON</button>
<input id="importFile" type="file" accept=".json,application/json" style="display:none">
<label>Nuovo indirizzo (Prog)<input id="newAddr" type="number" min="0" max="254" value="1"></label>
<button id="prog">Programma indirizzo</button>
</div>
<p class="small">Nome interno, indirizzo, tipo, range canali, nome+stanza per ogni canale.</p>
</div>
<div class="box">
<div class="row">
<label><span>NEWT abilitato</span><input id="newtEnabled" type="checkbox"></label>
<label>NEWT ID<input id="newtId" placeholder="id"></label>
<label>NEWT SECRET<input id="newtSecret" type="password" placeholder="secret"></label>
<label>NEWT ENDPOINT<input id="newtEndpoint" placeholder="https://..."></label>
</div>
<div class="row">
<button id="restartApp">Riavvia servizio</button>
<button id="restartNewt">Riavvia newt</button>
</div>
</div>
<div class="box">
<div class="row">
<label>Connessione<select id="netMode"><option value="ethernet">Ethernet</option><option value="wifi">WiFi</option></select></label>
<label id="wifiSsidWrap">WiFi SSID<input id="wifiSsid" placeholder="nome rete"></label>
<label id="wifiPassWrap">WiFi Password<input id="wifiPass" type="password" placeholder="password"></label>
<button id="applyNet">Applica rete</button>
<button id="loadSys">Aggiorna stato</button>
</div>
<pre id="sys"></pre>
</div>
<div class="box"><div id="boards"></div></div>
<pre id="msg"></pre>
<script>
const $=s=>document.querySelector(s),msg=$("#msg"),boardsEl=$("#boards"),sysEl=$("#sys"),imp=$("#importFile");
const f={serialPort:$("#serialPort"),baudrate:$("#baudrate"),timeout:$("#timeout"),displayName:$("#displayName"),token:$("#token"),newAddr:$("#newAddr"),newtEnabled:$("#newtEnabled"),newtId:$("#newtId"),newtSecret:$("#newtSecret"),newtEndpoint:$("#newtEndpoint"),netMode:$("#netMode"),wifiSsid:$("#wifiSsid"),wifiPass:$("#wifiPass"),wifiSsidWrap:$("#wifiSsidWrap"),wifiPassWrap:$("#wifiPassWrap")};
const S={boards:[]};
const esc=v=>String(v??"").replace(/[&<>'"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const nint=(v,d)=>{const n=Number(v);return Number.isFinite(n)?Math.trunc(n):d};
const clamp=(n,a,b)=>Math.min(b,Math.max(a,n));
const clean=(v,d)=>{const s=String(v||"").toLowerCase().replace(/[^a-z0-9_-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");return s||d};
const maxBy=k=>k==="shutter"?4:8;
const defName=(k,ch)=>k==="light"?`Luce ${ch}`:k==="shutter"?`Tapparella ${ch}`:`Termostato ${ch}`;
function note(t,e){msg.textContent=t;msg.style.color=e?"#a21":"#111"}
function sysNote(t,e){sysEl.textContent=t;sysEl.style.color=e?"#a21":"#111"}
async function gj(u){const r=await fetch(u,{cache:"no-store"});const j=await r.json();if(!r.ok)throw new Error(j.error||("HTTP "+r.status));return j}
async function pj(u,p){const r=await fetch(u,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(p)});const j=await r.json();if(!r.ok)throw new Error(j.error||("HTTP "+r.status));return j}
function nb(raw,i){const b=raw&&typeof raw==="object"?raw:{},k=(b.kind==="light"||b.kind==="shutter"||b.kind==="thermostat")?b.kind:"light",mx=maxBy(k),id=clean(b.id||b.name,`board-${i+1}`);let s=clamp(nint(b.channelStart,1),1,mx),e=clamp(nint(b.channelEnd,mx),1,mx);if(e<s)e=s;const names={},rooms={};for(const c of (Array.isArray(b.channels)?b.channels:[])){const n=clamp(nint(c?.channel,-1),1,mx);if(n<s||n>e)continue;names[n]=String(c?.name||"").trim()||defName(k,n);rooms[n]=String(c?.room||"").trim()||"Senza stanza"}const ch=[];for(let n=s;n<=e;n++)ch.push({channel:n,name:names[n]||defName(k,n),room:rooms[n]||"Senza stanza"});return{id,name:id,address:clamp(nint(b.address,i+1),0,254),kind:k,channelStart:s,channelEnd:e,channels:ch}}
const nbs=list=>(Array.isArray(list)?list:[]).map((x,i)=>nb(x,i));
function draw(){if(!S.boards.length){boardsEl.innerHTML='<p class="small">Nessuna scheda.</p>';return}boardsEl.innerHTML=S.boards.map((b,i)=>{const opts=`<option value="light" ${b.kind==="light"?"selected":""}>Luci</option><option value="shutter" ${b.kind==="shutter"?"selected":""}>Tapparelle</option><option value="thermostat" ${b.kind==="thermostat"?"selected":""}>Termostati</option>`;const rows=b.channels.map((c,j)=>`<div class="ch"><span>Can ${c.channel}</span><input class="nm" value="${esc(c.name)}" placeholder="Nome" oninput="setChName(${i},${j},this.value)"><input class="rm" value="${esc(c.room||"Senza stanza")}" placeholder="Stanza" oninput="setChRoom(${i},${j},this.value)"></div>`).join("");return `<div class="board"><h2>Scheda ${i+1}</h2><div class="row"><label>Nome interno<input value="${esc(b.id)}" oninput="setBid(${i},this.value)"></label><label>Indirizzo<input type="number" min="0" max="254" value="${b.address}" onchange="setBaddr(${i},this.value)"></label><label>Tipo<select onchange="setBkind(${i},this.value)">${opts}</select></label><label>Da<input type="number" min="1" max="${maxBy(b.kind)}" value="${b.channelStart}" onchange="setBstart(${i},this.value)"></label><label>A<input type="number" min="1" max="${maxBy(b.kind)}" value="${b.channelEnd}" onchange="setBend(${i},this.value)"></label><button onclick="delB(${i})">Rimuovi</button></div><div class="channels">${rows}</div></div>`}).join("")}
window.addB=()=>{S.boards.push(nb({},S.boards.length));draw()};
window.delB=i=>{S.boards.splice(i,1);S.boards=nbs(S.boards);draw()};
window.setBid=(i,v)=>{const id=clean(v,`board-${i+1}`);S.boards[i].id=id;S.boards[i].name=id;draw()};
window.setBaddr=(i,v)=>{S.boards[i].address=clamp(nint(v,S.boards[i].address),0,254);S.boards[i]=nb(S.boards[i],i);draw()};
window.setBkind=(i,v)=>{S.boards[i].kind=(v==="light"||v==="shutter"||v==="thermostat")?v:"light";S.boards[i]=nb(S.boards[i],i);draw()};
window.setBstart=(i,v)=>{S.boards[i].channelStart=nint(v,S.boards[i].channelStart);S.boards[i]=nb(S.boards[i],i);draw()};
window.setBend=(i,v)=>{S.boards[i].channelEnd=nint(v,S.boards[i].channelEnd);S.boards[i]=nb(S.boards[i],i);draw()};
window.setChName=(bi,ci,v)=>{S.boards[bi].channels[ci].name=String(v||"").trim()||defName(S.boards[bi].kind,S.boards[bi].channels[ci].channel)};
window.setChRoom=(bi,ci,v)=>{S.boards[bi].channels[ci].room=String(v||"").trim()||"Senza stanza"};
function toggleWifi(){const w=f.netMode.value==="wifi";f.wifiSsidWrap.classList.toggle("hidden",!w);f.wifiPassWrap.classList.toggle("hidden",!w)}
function payload(){S.boards=nbs(S.boards);return{serial:{port:f.serialPort.value.trim(),baudrate:nint(f.baudrate.value,9600),timeoutMs:nint(f.timeout.value,1200)},displayName:f.displayName.value.trim()||"Controllo Casa",apiToken:f.token.value.trim(),newt:{enabled:!!f.newtEnabled.checked,id:f.newtId.value.trim(),secret:f.newtSecret.value,endpoint:f.newtEndpoint.value.trim()||"https://app.pangolin.net"},network:{mode:f.netMode.value==="wifi"?"wifi":"ethernet",wifi:{ssid:f.wifiSsid.value.trim(),password:f.wifiPass.value}},boards:S.boards}}
function ts(){const d=new Date(),p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`}
function tokenQ(){return encodeURIComponent(f.token.value.trim())}
function applyCfg(c){f.serialPort.value=c.serial?.port||"/dev/ttyS0";f.baudrate.value=c.serial?.baudrate||9600;f.timeout.value=c.serial?.timeoutMs||1200;f.displayName.value=c.displayName||"Controllo Casa";f.token.value=c.apiToken||"";f.newtEnabled.checked=!!c.newt?.enabled;f.newtId.value=c.newt?.id||"";f.newtSecret.value=c.newt?.secret||"";f.newtEndpoint.value=c.newt?.endpoint||"https://app.pangolin.net";f.netMode.value=(c.network?.mode==="wifi"?"wifi":"ethernet");f.wifiSsid.value=c.network?.wifi?.ssid||"";f.wifiPass.value=c.network?.wifi?.password||"";toggleWifi();S.boards=nbs(c.boards||[]);draw()}
async function load(){try{applyCfg(await gj('/api/config'));note('Configurazione caricata');await loadSystem()}catch(e){note(e.message,true)}}
async function saveCurrent(quiet){const out=await pj('/api/config',payload());applyCfg(out.config||{});if(!quiet)note('Configurazione salvata');return out}
async function save(){try{await saveCurrent(false);await loadSystem()}catch(e){note(e.message,true)}}
function dl(){try{const raw=JSON.stringify(payload(),null,2)+"\n",blob=new Blob([raw],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="algodomoiot-config-"+ts()+".json";document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0);note('JSON scaricato')}catch(e){note(e.message,true)}}
function up(){imp.value="";imp.click()}
async function upf(ev){const file=ev.target.files&&ev.target.files[0];if(!file)return;try{applyCfg((await pj('/api/config',JSON.parse(await file.text()))).config||{});note('JSON caricato');await loadSystem()}catch(e){note('Errore JSON: '+e.message,true)}}
async function prog(){try{if(!f.token.value.trim())throw new Error('Token mancante');const a=nint(f.newAddr.value,1),r=await gj('/api/cmd/program-address?token='+tokenQ()+'&address='+encodeURIComponent(a));note('Programmazione OK ACK='+r.ackHex+' ('+r.ack+')')}catch(e){note(e.message,true)}}
function fmtSystem(s){const ifs=(s.interfaces||[]).map(i=>`${i.name} (${i.type}) ${i.state} ${((i.ips||[]).join(', ')||'-')}`).join('\n')||'-';const ips=(s.ips||[]).join(', ')||'-';const sv=s.services||{};return `Hostname: ${s.hostname||'-'}\nIP: ${ips}\nServizio app: ${sv.app||'-'}\nServizio newt: ${sv.newt||'-'}\nInterfacce:\n${ifs}`}
async function loadSystem(){const t=f.token.value.trim();if(!t){sysNote('Inserisci/salva token per leggere stato sistema',false);return}try{const r=await gj('/api/system/info?token='+tokenQ());sysNote(fmtSystem(r.system||{}),false)}catch(e){sysNote('Errore stato: '+e.message,true)}}
async function restartSvc(name){const t=f.token.value.trim();if(!t){note('Token mancante',true);return}try{await saveCurrent(true);const r=await gj('/api/admin/restart?token='+tokenQ()+'&service='+encodeURIComponent(name));note(r.message||'Restart inviato');setTimeout(loadSystem,800)}catch(e){note(e.message,true)}}
async function applyNetwork(){const t=f.token.value.trim();if(!t){note('Token mancante',true);return}try{await saveCurrent(true);const r=await gj('/api/admin/apply-network?token='+tokenQ());note(r.message||'Rete applicata');if(r.system)sysNote(fmtSystem(r.system),false)}catch(e){note(e.message,true)}}
f.netMode.onchange=toggleWifi;$("#reload").onclick=load;$("#addBoard").onclick=window.addB;$("#save").onclick=save;$("#downloadJson").onclick=dl;$("#uploadJson").onclick=up;imp.onchange=upf;$("#prog").onclick=prog;$("#loadSys").onclick=loadSystem;$("#restartApp").onclick=()=>restartSvc('app');$("#restartNewt").onclick=()=>restartSvc('newt');$("#applyNet").onclick=applyNetwork;load();
</script>
</body>
</html>
