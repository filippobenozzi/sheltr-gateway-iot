<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AlgoDomo Config</title>
<style>
body{font:14px/1.3 system-ui,-apple-system,sans-serif;margin:12px;background:#f6f7f8;color:#111}
h1{font-size:18px;margin:0 0 8px}
.row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
label{display:flex;flex-direction:column;gap:2px;font-size:12px}
input,textarea,button{font:13px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
input,textarea{border:1px solid #b8bec6;border-radius:6px;padding:6px;background:#fff}
textarea{width:100%;min-height:260px;resize:vertical}
button{border:1px solid #333;background:#fff;border-radius:6px;padding:6px 9px;cursor:pointer}
button:hover{background:#eef2f7}
.box{background:#fff;border:1px solid #c9ced6;border-radius:8px;padding:10px;margin-top:8px}
.small{font-size:12px;color:#444;margin:3px 0}
#msg{white-space:pre-wrap;font-size:12px;background:#fff;border:1px solid #c9ced6;border-radius:6px;padding:8px;min-height:24px}
</style>
</head>
<body>
<h1>Configurazione AlgoDomo</h1>

<div class="box">
<div class="row">
<label>Porta seriale<input id="serialPort" value="/dev/ttyS0"></label>
<label>Baudrate<input id="baudrate" type="number" value="9600"></label>
<label>Timeout ms<input id="timeout" type="number" value="1200"></label>
<label>Token API GET<input id="token"></label>
</div>
<div class="row">
<button id="reload">Ricarica</button>
<button id="format">Formatta JSON</button>
<button id="save">Salva</button>
<label>Nuovo indirizzo scheda (Prog)
<input id="newAddr" type="number" min="0" max="254" value="1">
</label>
<button id="prog">Programma indirizzo</button>
</div>
<p class="small">Ogni scheda: <b>name</b>, <b>address</b>, <b>channelStart</b>, <b>channelEnd</b>, <b>kind</b> (<code>light|shutter|thermostat</code>), <b>channels[]</b> con nome per canale.</p>
</div>

<div class="box">
<p class="small">Schede</p>
<textarea id="boards"></textarea>
</div>

<pre id="msg"></pre>

<script>
const $=s=>document.querySelector(s);
const msg=$("#msg");
const fields={
serialPort:$("#serialPort"),baudrate:$("#baudrate"),timeout:$("#timeout"),token:$("#token"),
boards:$("#boards"),newAddr:$("#newAddr")
};

function note(t,err){msg.textContent=t;msg.style.color=err?"#a21":"#111"}
async function getJson(u){const r=await fetch(u,{cache:"no-store"});const j=await r.json();if(!r.ok)throw new Error(j.error||("HTTP "+r.status));return j}
async function postJson(u,p){const r=await fetch(u,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(p)});const j=await r.json();if(!r.ok)throw new Error(j.error||("HTTP "+r.status));return j}

function parseBoards(){
try{return JSON.parse(fields.boards.value||"[]")}
catch(e){throw new Error("boards JSON non valido: "+e.message)}
}

function payload(){
return {
serial:{port:fields.serialPort.value.trim(),baudrate:Number(fields.baudrate.value),timeoutMs:Number(fields.timeout.value)},
apiToken:fields.token.value.trim(),
boards:parseBoards()
};
}

function tokenQ(){return encodeURIComponent(fields.token.value.trim())}

async function load(){
try{
const c=await getJson("/api/config");
fields.serialPort.value=c.serial?.port||"/dev/ttyS0";
fields.baudrate.value=c.serial?.baudrate||9600;
fields.timeout.value=c.serial?.timeoutMs||1200;
fields.token.value=c.apiToken||"";
fields.boards.value=JSON.stringify(c.boards||[],null,2);
note("Configurazione caricata");
}catch(e){note(e.message,true)}
}

async function save(){
try{const out=await postJson("/api/config",payload());fields.token.value=out.config.apiToken;note("Configurazione salvata")}
catch(e){note(e.message,true)}
}

function formatJson(){
try{fields.boards.value=JSON.stringify(parseBoards(),null,2);note("JSON formattato")}
catch(e){note(e.message,true)}
}

async function programAddress(){
try{
if(!fields.token.value.trim())throw new Error("Token mancante");
const a=Number(fields.newAddr.value);
const r=await getJson("/api/cmd/program-address?token="+tokenQ()+"&address="+encodeURIComponent(a));
note("Programmazione inviata. ACK="+r.ackHex+" ("+r.ack+")");
}catch(e){note(e.message,true)}
}

$("#reload").onclick=load;
$("#save").onclick=save;
$("#format").onclick=formatJson;
$("#prog").onclick=programAddress;
load();
</script>
</body>
</html>
