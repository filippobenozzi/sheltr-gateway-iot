<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AlgoDomo Control</title>
<meta name="theme-color" content="#1e3a57">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="icon" href="/icon.svg" type="image/svg+xml">
<style>body{margin:0;padding:10px;box-sizing:border-box;min-height:100vh;display:flex;flex-direction:column;font:13px/1.3 system-ui,-apple-system,sans-serif;background:#eef1f5;color:#142033}h1{font-size:17px;margin:0 0 8px}#top,#bulk{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:0 0 8px}#bulk{display:none}button,input{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}button{border:1px solid #6a7482;background:#fff;border-radius:9px;padding:6px 9px;cursor:pointer}button:hover{background:#f4f7fb}button:disabled{opacity:.55;cursor:not-allowed}.room{background:#fff;border:1px solid #ced5de;border-radius:12px;padding:10px;margin:10px 0}.room h2{font-size:15px;margin:0 0 8px}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}.card{border:1px solid #d7dce3;border-radius:10px;background:#f9fbfd;padding:8px}.tt{font-weight:700;margin-bottom:4px}.meta{font-size:11px;color:#5b6470;margin-bottom:6px}.state{display:inline-block;padding:2px 7px;border-radius:999px;border:1px solid #c4cbd4;background:#fff;font-size:11px;margin:0 4px 6px 0}.state.on{background:#e9f8ee;border-color:#9bc8a6;color:#1b6b2f}.state.off{background:#fdebec;border-color:#e3a3a7;color:#9c252d}.a{display:flex;gap:6px;flex-wrap:wrap}.mode{padding:6px 0 10px}.a button{padding:6px 8px;border-radius:8px}.a .pri{background:#1e3a57;color:#fff;border-color:#1e3a57}.a .pri:hover{background:#274967}.a .lon,.a .lon:hover{background:#1b6b2f;border-color:#1b6b2f;color:#fff}.a .loff,.a .loff:hover{background:#9c252d;border-color:#9c252d;color:#fff}.cur{margin:7px 0 8px;padding:8px;border:1px solid #bcc7d5;border-radius:9px;background:#fff;font-size:13px;font-weight:700}.tset{display:flex;gap:6px;align-items:center}.tset input[type=range]{width:118px}.sval{min-width:44px;font-size:12px;font-weight:700}#msg{font-size:12px;border:1px solid #c9ced6;border-radius:8px;background:#fff;padding:8px;white-space:pre-wrap}.small{font-size:12px;color:#4b5563}.foot{margin-top:auto;padding:10px 0 2px;text-align:center;font-style:italic;font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#505a66}.foot a{color:inherit}</style>
</head>
<body>
<h1 id="pageTitle">Controllo Casa</h1>
<div id="top"><button id="refresh">Aggiorna</button><span class="small" id="last"></span></div>
<div id="bulk"><button id="allLightsOff">Spegni tutte le luci</button><button id="allShuttersDown">Tapparelle GIU tutte</button></div>
<div id="rooms"></div>
<pre id="msg"></pre>
<footer class="foot">not all those who wander are lost ~ <a href="https://filippo.im" target="_blank" rel="noopener">filippo.im</a></footer>
<script>
const $=s=>document.querySelector(s),titleEl=$("#pageTitle"),roomsEl=$("#rooms"),msg=$("#msg"),last=$("#last"),bulkEl=$("#bulk"),bLight=$("#allLightsOff"),bShut=$("#allShuttersDown");
let token="",running=false,bulk=false,cfg=null;
const esc=v=>String(v??"").replace(/[&<>'"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const sq=v=>String(v??"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
const sid=v=>String(v??"").replace(/[^a-zA-Z0-9_-]/g,"_");
function note(t,e){msg.textContent=t;msg.style.color=e?"#a21":"#1b2430"}
async function gj(u){const r=await fetch(u,{cache:"no-store"});const j=await r.json();if(!r.ok)throw new Error(j.error||("HTTP "+r.status));return j}
function lightCard(x){const st=x.isOn===null?"?":(x.isOn?"ON":"OFF"),sc=x.isOn===true?' on':(x.isOn===false?' off':''),on=x.isOn===true?' class="pri lon"':'',off=x.isOn===false?' class="pri loff"':'';return '<div class="card"><div class="tt">'+esc(x.name)+'</div><div class="meta">'+esc(x.boardName)+' · ch '+x.channel+'</div><div class="state'+sc+'">'+st+'</div><div class="a"><button'+on+' onclick="cmdLight(\''+sq(x.id)+'\',\'on\')">ON</button><button'+off+' onclick="cmdLight(\''+sq(x.id)+'\',\'off\')">OFF</button></div></div>'}
function shutterCard(x){return '<div class="card"><div class="tt">'+esc(x.name)+'</div><div class="meta">'+esc(x.boardName)+' · ch '+x.channel+'</div><div class="state">'+esc(x.action||"unknown")+'</div><div class="a"><button onclick="cmdShutter(\''+sq(x.id)+'\',\'up\')">SU</button><button onclick="cmdShutter(\''+sq(x.id)+'\',\'stop\')">STOP</button><button onclick="cmdShutter(\''+sq(x.id)+'\',\'down\')">GIU</button></div></div>'}
function thermoCard(x){const bid=sid(x.id),rid='sp-'+bid,vid='sv-'+bid,t=x.temperature===null?'--.- C':Number(x.temperature).toFixed(1)+' C',cur=Number(x.setpoint),set=Number.isFinite(cur)?Math.max(5,Math.min(30,cur)):21,p=x.isOn===true?'ON':'OFF',m=(x.mode==='summer'?'ESTATE':'INVERNO'),w=x.mode==='winter'?' class="pri"':'',sm=x.mode==='summer'?' class="pri"':'';return '<div class="card"><div class="tt">'+esc(x.name)+'</div><div class="meta">'+esc(x.boardName)+' · ch '+x.channel+'</div><div class="state">'+p+'</div><div class="state">'+m+'</div><div class="cur">T: '+t+'</div><div class="a mode"><button'+w+' onclick="cmdThermoMode(\''+sq(x.id)+'\',\'winter\')">INVERNO</button><button'+sm+' onclick="cmdThermoMode(\''+sq(x.id)+'\',\'summer\')">ESTATE</button></div><div class="tset"><input id="'+rid+'" type="range" min="5" max="30" step="0.5" value="'+set.toFixed(1)+'" oninput="syncSlider(\''+rid+'\',\''+vid+'\')"><span id="'+vid+'" class="sval">'+set.toFixed(1)+' C</span><button class="pri" onclick="cmdThermoSet(\''+sq(x.id)+'\',\''+rid+'\')">SET</button></div></div>'}
function roomBlock(r){let cards='';for(const x of (r.lights||[]))cards+=lightCard(x);for(const x of (r.shutters||[]))cards+=shutterCard(x);for(const x of (r.thermostats||[]))cards+=thermoCard(x);if(!cards)cards='<div class="small">Nessuna entita</div>';return '<section class="room"><h2>'+esc(r.name)+'</h2><div class="grid">'+cards+'</div></section>'}
function render(data){const rooms=data.rooms||[];if(!rooms.length){roomsEl.innerHTML='<section class="room"><div class="small">Nessuna stanza configurata</div></section>';return}roomsEl.innerHTML=rooms.map(roomBlock).join('');last.textContent='ultimo update: '+new Date(data.updatedAt||Date.now()).toLocaleTimeString();if((data.refreshErrors||[]).length)note('Errori polling: '+data.refreshErrors.map(e=>e.address+':'+e.error).join(' | '),true)}
function bulkDisabled(v){bLight.disabled=v;bShut.disabled=v}
function ids(kind){const out=[];for(const b of (cfg?.boards||[])){if(b.kind!==kind)continue;const bid=String(b.id||'').trim();if(!bid)continue;for(const c of (b.channels||[])){const n=Number(c?.channel);if(Number.isFinite(n))out.push(bid+'-c'+Math.trunc(n));}}return out}
function syncBulkVisibility(){const hasLight=ids('light').length>0,hasShutter=ids('shutter').length>0;bLight.style.display=hasLight?'':'none';bShut.style.display=hasShutter?'':'none';bulkEl.style.display=(hasLight||hasShutter)?'flex':'none'}
async function refresh(){if(running||bulk||!token)return;running=true;try{const d=await gj('/api/status?token='+encodeURIComponent(token)+'&refresh=0');render(d);if(!(d.refreshErrors||[]).length)note('OK')}catch(e){note(e.message,true)}finally{running=false}}
async function cmd(url,doRefresh=true){try{const r=await gj(url);if(Array.isArray(r.frames)&&r.frames.length)note('Comandi: '+r.frames.map(x=>x.type+': '+(x.frame?.hex||'?')).join(' | '));else if(r.frame?.hex)note('Comando: '+r.frame.hex);else note('Comando eseguito');if(doRefresh)await refresh()}catch(e){note(e.message,true)}}
async function runAll(kind,action,label){if(!token||bulk)return;const list=ids(kind);if(!list.length){note('Nessuna entita '+label);return}bulk=true;bulkDisabled(true);let ok=0,ko=0,ep=kind==='light'?'/api/cmd/light':'/api/cmd/shutter';for(const id of list){try{await gj(ep+'?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));ok++}catch(_){ko++}}bulk=false;bulkDisabled(false);note(label+': '+ok+' ok'+(ko?', '+ko+' errori':''),ko>0);await refresh()}
window.syncSlider=(rid,vid)=>{const r=document.getElementById(rid),v=document.getElementById(vid);if(r&&v){const n=Number(r.value);v.textContent=(Number.isFinite(n)?n.toFixed(1):'--.-')+' C'}};
window.cmdLight=(id,action)=>cmd('/api/cmd/light?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));
window.cmdShutter=(id,action)=>cmd('/api/cmd/shutter?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));
window.cmdThermoSet=(id,inputId)=>{const v=document.getElementById(inputId)?.value;return cmd('/api/cmd/thermostat?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&set='+encodeURIComponent(v));};
window.cmdThermoMode=(id,m)=>cmd('/api/cmd/thermostat?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&mode='+encodeURIComponent(m));
async function init(){try{cfg=await gj('/api/config');const n=String(cfg.displayName||'').trim()||'Controllo Casa';titleEl.textContent=n;document.title=n;token=cfg.apiToken||'';if(!token)throw new Error('Token non configurato: apri /config');syncBulkVisibility();note('Token caricato.');await refresh()}catch(e){note(e.message,true)}}
if('serviceWorker' in navigator)window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(()=>{})});
$("#refresh").onclick=refresh;bLight.onclick=()=>runAll('light','off','Luci OFF globali');bShut.onclick=()=>runAll('shutter','down','Tapparelle GIU globali');init();
</script>
</body>
</html>
