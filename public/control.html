<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>AlgoDomo Control</title>
<meta name="theme-color" content="#191919">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="icon" href="/icon.svg" type="image/svg+xml">
<style>
:root{--bg:#191919;--section:#202020;--fg:#f0efed;--muted:#bcbab6;--bd:#bcbab6;--s1:4px;--s2:8px;--s3:12px;--mono:ui-monospace,SFMono-Regular,Menlo,Consolas,Monaco,Liberation Mono,monospace}
*{box-sizing:border-box}
body{margin:0;padding:var(--s3);min-height:100vh;display:flex;flex-direction:column;background:var(--bg);color:var(--fg);font:13px/1.35 var(--mono)}
.brand{display:flex;align-items:center;gap:var(--s2);margin:0 0 var(--s1)}
.logo{width:28px;height:28px;display:block;flex:0 0 28px}
h1{font-size:17px;margin:0}
#now{margin:0 0 var(--s2)}
#top,#bulk{display:flex;gap:var(--s2);align-items:center;flex-wrap:wrap;margin:0 0 var(--s2)}
#bulk{display:none}
button,input,select{font:11px/1.2 var(--mono)}
button{border:1px solid var(--bd);background:#191919;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
button:hover{background:#111}
button:disabled{opacity:.55;cursor:not-allowed}
input,select{border:1px solid var(--bd);border-radius:6px;padding:6px;background:var(--section);color:var(--fg)}
::placeholder{color:var(--muted);opacity:1}
.room{background:var(--section);border:1px solid var(--bd);border-radius:6px;padding:var(--s3);margin:var(--s3) 0}
.room h2{font-size:15px;margin:0 0 var(--s2)}
.grid{display:flex;flex-wrap:wrap;gap:var(--s2)}
.card{position:relative;width:100%;max-width:250px;border:1px solid var(--bd);border-radius:6px;background:var(--section);padding:var(--s2);display:flex;flex-direction:column;justify-content:center;text-align:center}
.hd{display:flex;align-items:center;justify-content:space-between;width:100%;gap:var(--s2)}
.tt{font-weight:700;margin:8px auto 2px}
.gear{position:absolute;top:-1px;right:-1px;border:1px solid var(--bd);background:#2b2b2b;color:var(--muted);min-width:26px;padding:3px;border-radius:0px 6px 0px 6px;font-size:16px;line-height:1}
.gear.on{border-color:#2563eb;background:#2563eb;color:#fff}
.ts{font-size:11px;color:var(--muted);font-weight:700;margin:0 0 6px}
.dot{display:inline-block;width:8px;height:8px;border-radius:6px;margin:auto 6px}
.dot.on{background:#2563eb}
.dot.off{background:#7b7b7b}
.a{display:flex;margin:6px auto;flex-wrap:wrap}
.mode{padding:6px 0 10px;margin:auto}
.a button{margin-right:5px;min-width:50px;padding:4px 6px;border-radius:6px}
.card.sh .a button{min-width:30px}
.a .pri{background:#1e3a57;color:#fff;border-color:#1e3a57}
.a .pri:hover{background:#274967}
.a .act,.a .act:hover{background:#274967;border-color:#274967;color:#fff}
.a .lon,.a .lon:hover{background:#1b6b2f;border-color:#1b6b2f;color:#fff}
.a .loff,.a .loff:hover{background:#9c252d;border-color:#9c252d;color:#fff}
.tset{display:flex;margin:auto;gap:6px;align-items:center}
.tset input[type=range]{width:118px}
.sval{min-width:44px;font-size:12px;font-weight:700}
#msg{margin-top:var(--s2);font-size:12px;border:1px solid var(--bd);border-radius:6px;background:var(--section);color:var(--fg);padding:var(--s2);white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
#tpModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:var(--s3);z-index:20}
#tpModal.hidden{display:none}
#tpBox{width:min(560px,100%);max-height:90vh;overflow:auto;background:var(--section);border:1px solid var(--bd);border-radius:6px;padding:var(--s3)}
#tpBox h2{font-size:14px;margin:0 0 var(--s2)}
.tpe{display:flex;align-items:center;gap:var(--s2);font-size:12px;margin:0 0 var(--s2);color:var(--muted)}
#tpRows{display:flex;flex-direction:column;gap:var(--s2)}
.tr{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.tr input,.tr select{border:1px solid var(--bd);border-radius:6px;padding:5px;background:var(--section);color:var(--fg)}
.tr .rm{min-width:28px;padding:5px 6px}
.days{display:flex;gap:6px;flex-wrap:wrap}
.dw{display:inline-flex;align-items:center;gap:4px;border:1px solid var(--bd);border-radius:6px;padding:2px 6px;font-size:11px;background:var(--section);color:var(--fg)}
.dw input{margin:0}
.trb{border:1px dashed var(--bd);border-radius:6px;padding:6px}
.tpb{display:flex;gap:var(--s2);flex-wrap:wrap;margin:var(--s3) 0 0}
.foot{margin-top:auto;padding:var(--s3) 0 2px;text-align:center;font-style:italic;font:12px/1.3 var(--mono);color:var(--muted)}
.foot a{color:inherit}
.hidden{display:none}
@media (max-width:576px){.card.temp{width:100%;max-width:550px}.card{width:50%;}}
</style>
</head>
<body>
<div class="brand"><img class="logo" src="/logo.svg" alt="Logo"><h1 id="pageTitle">Controllo Casa</h1></div>
<div class="small" id="now"></div>
<div id="top"><button id="refresh">Aggiorna</button><span class="small" id="last"></span></div>
<div id="bulk"><button id="allLightsOff">Spegni tutte le luci</button><button id="allShuttersDown">Tapparelle GIU tutte</button></div>
<div id="rooms"></div>
<div id="tpModal" class="hidden">
  <div id="tpBox">
    <h2 id="tpTitle">Profilo Orario</h2>
    <label class="tpe"><span>Profilo orario abilitato</span><input id="tpEnabled" type="checkbox"></label>
    <div id="tpRows"></div>
    <div class="tpb"><button id="tpAdd">Aggiungi fascia</button><button id="tpSave" class="pri">Salva profilo</button><button id="tpClose">Chiudi</button></div>
  </div>
</div>
<pre id="msg"></pre>
<footer class="foot">not all those who wander are lost ~ <a href="https://filippo.im" target="_blank" rel="noopener">filippo.im</a></footer>
<script>
const $=s=>document.querySelector(s),titleEl=$("#pageTitle"),nowEl=$("#now"),roomsEl=$("#rooms"),msg=$("#msg"),last=$("#last"),bulkEl=$("#bulk"),bLight=$("#allLightsOff"),bShut=$("#allShuttersDown"),tpModal=$("#tpModal"),tpTitle=$("#tpTitle"),tpEnabled=$("#tpEnabled"),tpRows=$("#tpRows"),tpAdd=$("#tpAdd"),tpSave=$("#tpSave"),tpClose=$("#tpClose");
let token="",running=false,bulk=false,cfg=null,lastData=null,profiles={thermostat:{},light:{},shutter:{}},tpId="",tpKind="thermostat",tpData={enabled:false,entries:[]};
const esc=v=>String(v??"").replace(/[&<>'"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const sq=v=>String(v??"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
const sid=v=>String(v??"").replace(/[^a-zA-Z0-9_-]/g,"_");
const SH_HOLD_MS=60000,SH_VERIFY_MS=65000,shHold={},shVerify={};
const DOW=[{id:1,label:"Lun"},{id:2,label:"Mar"},{id:3,label:"Mer"},{id:4,label:"Gio"},{id:5,label:"Ven"},{id:6,label:"Sab"},{id:7,label:"Dom"}];
const DOW_ALL=DOW.map(x=>x.id);
function shAction(id){const h=shHold[id];if(h&&h.until>Date.now())return h.action;if(h)delete shHold[id];return""}
function scheduleShVerify(id){if(shVerify[id])clearTimeout(shVerify[id]);shVerify[id]=setTimeout(async()=>{delete shVerify[id];if(!token)return;try{await refresh(true)}catch(_){ }},SH_VERIFY_MS)}
function setShAction(id,action){if(action==="up"||action==="down"){shHold[id]={action:action,until:Date.now()+SH_HOLD_MS};setTimeout(()=>{const h=shHold[id];if(h&&h.until<=Date.now()){delete shHold[id];if(lastData)render(lastData,true)}},SH_HOLD_MS+120);scheduleShVerify(id);return}delete shHold[id]}
function note(t,e){msg.textContent=t;msg.style.color=e?"#ff8a80":"var(--fg)"}
async function gj(u){const r=await fetch(u,{cache:"no-store"});const j=await r.json();if(!r.ok)throw new Error(j.error||("HTTP "+r.status));return j}
async function pj(u,p){const r=await fetch(u,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(p)});const j=await r.json();if(!r.ok)throw new Error(j.error||("HTTP "+r.status));return j}
function chId(bid,ch){return String(bid||"").trim()+"-c"+Math.trunc(Number(ch)||0)}
function clamp(n,a,b){return Math.min(b,Math.max(a,n))}
function normMode(v){return String(v||"").toLowerCase()==="summer"?"summer":"winter"}
function normTime(v,d){const s=String(v||"").trim();if(!/^\d{2}:\d{2}$/.test(s))return d;const h=Number(s.slice(0,2)),m=Number(s.slice(3,5));if(!Number.isFinite(h)||!Number.isFinite(m)||h<0||h>23||m<0||m>59)return d;return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`}
function normDay(v){const n=Number(v);if(Number.isFinite(n)){const i=Math.trunc(n);if(i>=1&&i<=7)return i}const k=String(v||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[\s_.-]/g,"");const m={mon:1,monday:1,lun:1,lunedi:1,tue:2,tuesday:2,mar:2,martedi:2,wed:3,wednesday:3,mer:3,mercoledi:3,thu:4,thursday:4,gio:4,giovedi:4,fri:5,friday:5,ven:5,venerdi:5,sat:6,saturday:6,sab:6,sabato:6,sun:7,sunday:7,dom:7,domenica:7,"1":1,"2":2,"3":3,"4":4,"5":5,"6":6,"7":7};return m[k]||0}
function normDays(v){const out=[];if(v&&typeof v==="object"&&!Array.isArray(v)){for(const [k,on] of Object.entries(v)){if(!on)continue;const d=normDay(k);if(d)out.push(d)}}else{const a=Array.isArray(v)?v:[v];for(const x of a){const d=normDay(x);if(d)out.push(d)}}const u=[...new Set(out)].sort((a,b)=>a-b);return u.length?u:DOW_ALL.slice()}
function patchDays(days,day,enabled){const set=new Set(normDays(days));if(enabled)set.add(day);else set.delete(day);const out=[...set].sort((a,b)=>a-b);return out.length?out:DOW_ALL.slice()}
function normThermoEntry(e){const n=Number(e?.setpoint);return{from:normTime(e?.from,"00:00"),to:normTime(e?.to,"23:59"),setpoint:Number.isFinite(n)?clamp(Math.round(n*2)/2,5,30):21,mode:normMode(e?.mode),days:normDays(e?.days)}}
function normThermoProfile(p){const entries=(Array.isArray(p?.entries)?p.entries:[]).map(normThermoEntry).slice(0,48);return{enabled:!!p?.enabled,entries}}
function normSwitchEntry(kind,e){const d=kind==="shutter"?"down":"off",a=String(e?.action||d).toLowerCase(),action=kind==="shutter"?(a==="up"?"up":"down"):(a==="on"?"on":"off");return{time:normTime(e?.time,"00:00"),action,days:normDays(e?.days)}}
function normSwitchProfile(kind,p){const entries=(Array.isArray(p?.entries)?p.entries:[]).map(e=>normSwitchEntry(kind,e)).slice(0,48);if(entries.length)return{enabled:!!p?.enabled,entries};if((p&&typeof p==="object")&&("time" in p||"action" in p||"days" in p))return{enabled:!!p?.enabled,entries:[normSwitchEntry(kind,p)]};return{enabled:!!p?.enabled,entries:[]}}
function rebuildProfiles(){const map={thermostat:{},light:{},shutter:{}};for(const b of (cfg?.boards||[])){const k=b?.kind;if(k!=="thermostat"&&k!=="light"&&k!=="shutter")continue;for(const c of (b?.channels||[])){const id=chId(b.id,c?.channel);map[k][id]=k==="thermostat"?normThermoProfile(c?.profile):normSwitchProfile(k,c?.profile)}}profiles=map}
function profileOf(kind,id){const byKind=profiles[kind]||{};if(byKind[id])return byKind[id];return{enabled:false,entries:[]}}
function setProfileInConfig(target,kind,id,profile){for(const b of (target?.boards||[])){if(b?.kind!==kind)continue;for(const c of (b?.channels||[])){if(chId(b.id,c?.channel)===id){c.profile=kind==="thermostat"?normThermoProfile(profile):normSwitchProfile(kind,profile);return true}}}return false}
function lightCard(x){const on=x.isOn===true?' class="pri lon"':'',off=x.isOn===false?' class="pri loff"':'',pe=profileOf("light",x.id).enabled?' on':'';return '<div class="card"><div class="hd"><div class="tt">'+esc(x.name)+'</div><button class="gear'+pe+'" title="Profilo orario" onclick="openLProfile(\''+sq(x.id)+'\')">⚙</button></div><div class="a"><button'+on+' onclick="cmdLight(\''+sq(x.id)+'\',\'on\')">ON</button><button'+off+' onclick="cmdLight(\''+sq(x.id)+'\',\'off\')">OFF</button></div></div>'}
function dimmerCard(x){const bid=sid(x.id),rid='dm-'+bid,vid='dv-'+bid,l=Number(x.level),set=Number.isFinite(l)?Math.max(0,Math.min(9,Math.round(l))):0,on=x.isOn===true?' class="pri lon"':'',off=x.isOn===false?' class="pri loff"':'';return '<div class="card temp"><div class="tt">'+esc(x.name)+'</div><div class="a"><button'+on+' onclick="cmdDimmerAction(\''+sq(x.id)+'\',\'on\')">ON</button><button'+off+' onclick="cmdDimmerAction(\''+sq(x.id)+'\',\'off\')">OFF</button></div><div class="tset"><input id="'+rid+'" type="range" min="0" max="9" step="1" value="'+set+'" oninput="syncDimmer(\''+rid+'\',\''+vid+'\')"><span id="'+vid+'" class="sval">'+set+'</span><button class="pri" onclick="cmdDimmerSet(\''+sq(x.id)+'\',\''+rid+'\')">SET</button></div></div>'}
function shutterCard(x){const a=shAction(x.id),up=a==="up"?' class="act"':'',down=a==="down"?' class="act"':'',pe=profileOf("shutter",x.id).enabled?' on':'';return '<div class="card sh"><div class="hd"><div class="tt">'+esc(x.name)+'</div><button class="gear'+pe+'" title="Profilo orario" onclick="openSProfile(\''+sq(x.id)+'\')">⚙</button></div><div class="a"><button'+up+' onclick="cmdShutter(\''+sq(x.id)+'\',\'up\')">SU</button><button onclick="cmdShutter(\''+sq(x.id)+'\',\'stop\')">STOP</button><button'+down+' onclick="cmdShutter(\''+sq(x.id)+'\',\'down\')">GIU</button></div></div>'}
function thermoCard(x){const bid=sid(x.id),rid='sp-'+bid,vid='sv-'+bid,t=x.temperature===null?'--.- C':Number(x.temperature).toFixed(1)+' C',a=(x.isActive===true)||(x.isActive==null&&x.isOn===true),p=a?'ACCESO':'SPENTO',d=a?'on':'off',cur=Number(x.setpoint),set=Number.isFinite(cur)?Math.max(5,Math.min(30,cur)):21,w=x.mode==='winter'?' class="pri"':'',sm=x.mode==='summer'?' class="pri"':'',pe=profileOf("thermostat",x.id).enabled?' on':'';return '<div class="card temp"><div class="hd"><div class="tt">'+esc(x.name)+'</div><button class="gear'+pe+'" title="Profilo orario" onclick="openTProfile(\''+sq(x.id)+'\')">⚙</button></div><div class="ts">Temp: '+t+'<span class="dot '+d+'"></span>'+p+'</div><div class="a mode"><button'+w+' onclick="cmdThermoMode(\''+sq(x.id)+'\',\'winter\')">INVERNO</button><button'+sm+' onclick="cmdThermoMode(\''+sq(x.id)+'\',\'summer\')">ESTATE</button></div><div class="tset"><input id="'+rid+'" type="range" min="5" max="30" step="0.5" value="'+set.toFixed(1)+'" oninput="syncSlider(\''+rid+'\',\''+vid+'\')"><span id="'+vid+'" class="sval">'+set.toFixed(1)+' C</span><button class="pri" onclick="cmdThermoSet(\''+sq(x.id)+'\',\''+rid+'\')">SET</button></div></div>'}
function sortByName(list){return [...(list||[])].sort((a,b)=>String(a?.name||"").localeCompare(String(b?.name||""),"it",{sensitivity:"base"}))}
function roomBlock(r){let cards='';for(const x of sortByName(r.thermostats))cards+=thermoCard(x);for(const x of sortByName(r.lights))cards+=lightCard(x);for(const x of sortByName(r.dimmers))cards+=dimmerCard(x);for(const x of sortByName(r.shutters))cards+=shutterCard(x);if(!cards)cards='<div class="small">Nessuna entita</div>';return '<section class="room"><h2>'+esc(r.name)+'</h2><div class="grid">'+cards+'</div></section>'}
function render(data,skipNote){lastData=data;const rooms=data.rooms||[];if(!rooms.length){roomsEl.innerHTML='<section class="room"><div class="small">Nessuna stanza configurata</div></section>';return}roomsEl.innerHTML=rooms.map(roomBlock).join('');last.textContent='ultimo update: '+new Date(data.updatedAt||Date.now()).toLocaleTimeString();if(!skipNote&&(data.refreshErrors||[]).length)note('Errori polling: '+data.refreshErrors.map(e=>e.address+':'+e.error).join(' | '),true)}
function bulkDisabled(v){bLight.disabled=v;bShut.disabled=v}
function ids(kind){const out=[];for(const b of (cfg?.boards||[])){if(b.kind!==kind)continue;const bid=String(b.id||'').trim();if(!bid)continue;for(const c of (b.channels||[])){const n=Number(c?.channel);if(Number.isFinite(n))out.push(bid+'-c'+Math.trunc(n));}}return out}
function syncBulkVisibility(){const hasLight=(ids('light').length+ids('dimmer').length)>0,hasShutter=ids('shutter').length>0;bLight.style.display=hasLight?'':'none';bShut.style.display=hasShutter?'':'none';bulkEl.style.display=(hasLight||hasShutter)?'flex':'none'}
async function refresh(poll){if(running||bulk||!token)return;running=true;try{const d=await gj('/api/status?token='+encodeURIComponent(token)+'&refresh='+(poll?1:0));render(d);if(!(d.refreshErrors||[]).length)note('OK')}catch(e){note(e.message,true)}finally{running=false}}
async function cmd(url,doRefresh=true){try{const r=await gj(url);if(Array.isArray(r.frames)&&r.frames.length)note('Comandi: '+r.frames.map(x=>x.type+': '+(x.frame?.hex||'?')).join(' | '));else if(r.frame?.hex)note('Comando: '+r.frame.hex);else note('Comando eseguito');if(doRefresh)await refresh(false)}catch(e){note(e.message,true)}}
async function runAll(kind,action,label){if(!token||bulk)return;bulk=true;bulkDisabled(true);let ok=0,ko=0;if(kind==='light'){for(const id of ids('light')){try{await gj('/api/cmd/light?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));ok++}catch(_){ko++}}for(const id of ids('dimmer')){try{await gj('/api/cmd/dimmer?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action=off');ok++}catch(_){ko++}}}else{for(const id of ids('shutter')){setShAction(id,action==='up'?'up':(action==='down'?'down':'stop'));try{await gj('/api/cmd/shutter?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));ok++}catch(_){ko++}}if(lastData)render(lastData,true)}bulk=false;bulkDisabled(false);if(!ok&&!ko){note('Nessuna entita '+label);return}note(label+': '+ok+' ok'+(ko?', '+ko+' errori':''),ko>0);await refresh(false)}
function rowDaysHtml(i,days){const d=normDays(days);return DOW.map(x=>'<label class="dw"><input type="checkbox" '+(d.includes(x.id)?'checked ':'')+'onchange="tpDay('+i+','+x.id+',this.checked)"><span>'+x.label+'</span></label>').join('')}
function switchOpts(kind,current){const c=String(current||"").toLowerCase();if(kind==="shutter")return '<option value="up"'+(c==="up"?' selected':'')+'>SU</option><option value="down"'+(c==="down"?' selected':'')+'>GIU</option>';return '<option value="on"'+(c==="on"?' selected':'')+'>ACCENDI</option><option value="off"'+(c==="off"?' selected':'')+'>SPEGNI</option>'}
function renderTpRows(){const rows=(tpData.entries||[]);if(!rows.length){tpRows.innerHTML='<div class="small">'+(tpKind==="thermostat"?'Nessuna fascia: fallback inverno 5C.':'Nessuna fascia oraria configurata.')+'</div>';return}if(tpKind==="thermostat"){tpRows.innerHTML=rows.map((e,i)=>'<div class="trb"><div class="tr"><input type="time" value="'+esc(e.from)+'" onchange="tpSet('+i+',\'from\',this.value)"><span>-></span><input type="time" value="'+esc(e.to)+'" onchange="tpSet('+i+',\'to\',this.value)"><input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" enterkeyhint="done" value="'+Number(e.setpoint).toFixed(1)+'" onchange="tpSet('+i+',\'setpoint\',this.value)"><select onchange="tpSet('+i+',\'mode\',this.value)"><option value="winter"'+(e.mode==="winter"?" selected":"")+'>INVERNO</option><option value="summer"'+(e.mode==="summer"?" selected":"")+'>ESTATE</option></select><button class="rm" onclick="tpDel('+i+')">X</button></div><div class="days">'+rowDaysHtml(i,e.days)+'</div></div>').join('');return}tpRows.innerHTML=rows.map((e,i)=>'<div class="trb"><div class="tr"><input type="time" value="'+esc(e.time)+'" onchange="tpSet('+i+',\'time\',this.value)"><select onchange="tpSet('+i+',\'action\',this.value)">'+switchOpts(tpKind,e.action)+'</select><button class="rm" onclick="tpDel('+i+')">X</button></div><div class="days">'+rowDaysHtml(i,e.days)+'</div></div>').join('')}
function openProfile(kind,id){tpKind=kind;tpId=id;tpTitle.textContent='Profilo Orario - '+id;tpData=kind==="thermostat"?normThermoProfile(profileOf("thermostat",id)):normSwitchProfile(kind,profileOf(kind,id));tpEnabled.checked=!!tpData.enabled;renderTpRows();tpModal.classList.remove('hidden')}
function closeTProfile(){tpModal.classList.add('hidden');tpId="";tpKind="thermostat";tpData={enabled:false,entries:[]}}
window.tpSet=(i,key,val)=>{const e=tpData.entries[i];if(!e)return;if(tpKind==="thermostat"){if(key==="from"||key==="to"){e[key]=normTime(val,key==="from"?"00:00":"23:59")}else if(key==="setpoint"){const n=Number(String(val||"").trim().replace(",","."));if(Number.isFinite(n))e.setpoint=clamp(Math.round(n*2)/2,5,30)}else if(key==="mode"){e.mode=normMode(val)}return}if(key==="time"){e.time=normTime(val,"00:00")}else if(key==="action"){e.action=normSwitchEntry(tpKind,{action:val}).action}}
window.tpDay=(i,d,on)=>{const e=tpData.entries[i];if(!e)return;e.days=patchDays(e.days,d,!!on)}
window.tpDel=i=>{tpData.entries.splice(i,1);renderTpRows()}
window.openTProfile=id=>openProfile("thermostat",id);
window.openLProfile=id=>openProfile("light",id);
window.openSProfile=id=>openProfile("shutter",id);
window.syncSlider=(rid,vid)=>{const r=document.getElementById(rid),v=document.getElementById(vid);if(r&&v){const n=Number(r.value);v.textContent=(Number.isFinite(n)?n.toFixed(1):'--.-')+' C'}};
window.syncDimmer=(rid,vid)=>{const r=document.getElementById(rid),v=document.getElementById(vid);if(r&&v){const n=Number(r.value);v.textContent=Number.isFinite(n)?String(Math.round(n)):'0'}};
window.cmdLight=(id,action)=>cmd('/api/cmd/light?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));
window.cmdDimmerSet=(id,inputId)=>{const v=document.getElementById(inputId)?.value;return cmd('/api/cmd/dimmer?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&level='+encodeURIComponent(v));};
window.cmdDimmerAction=(id,action)=>cmd('/api/cmd/dimmer?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));
window.cmdShutter=(id,action)=>{setShAction(id,action);if(lastData)render(lastData,true);return cmd('/api/cmd/shutter?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&action='+encodeURIComponent(action));};
window.cmdThermoSet=(id,inputId)=>{const v=document.getElementById(inputId)?.value;return cmd('/api/cmd/thermostat?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&set='+encodeURIComponent(v));};
window.cmdThermoMode=(id,m)=>cmd('/api/cmd/thermostat?token='+encodeURIComponent(token)+'&id='+encodeURIComponent(id)+'&mode='+encodeURIComponent(m));
function tickNow(){nowEl.textContent=new Date().toLocaleString('it-IT')}
async function init(){try{cfg=await gj('/api/config');rebuildProfiles();const n=String(cfg.displayName||'').trim()||'Controllo Casa';titleEl.textContent=n;document.title=n;token=cfg.apiToken||'';if(!token)throw new Error('Token non configurato: apri /config');syncBulkVisibility();tickNow();setInterval(tickNow,1000);note('Token caricato.');await refresh(false)}catch(e){note(e.message,true)}}
if('serviceWorker' in navigator)window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(()=>{})});
async function saveTProfile(){if(!tpId||!cfg)return;const nextCfg=JSON.parse(JSON.stringify(cfg));const profile=tpKind==="thermostat"?normThermoProfile({enabled:tpEnabled.checked,entries:tpData.entries}):normSwitchProfile(tpKind,{enabled:tpEnabled.checked,entries:tpData.entries});if(!setProfileInConfig(nextCfg,tpKind,tpId,profile)){note('Canale non trovato in config',true);return}try{const out=await pj('/api/config',nextCfg);cfg=out.config||nextCfg;rebuildProfiles();closeTProfile();if(lastData)render(lastData,true);note('Profilo orario salvato')}catch(e){note(e.message,true)}}
$("#refresh").onclick=()=>refresh(true);bLight.onclick=()=>runAll('light','off','Luci OFF globali');bShut.onclick=()=>runAll('shutter','down','Tapparelle GIU globali');tpAdd.onclick=()=>{if(tpKind==="thermostat"){tpData.entries.push(normThermoEntry({from:"08:00",to:"18:00",setpoint:21,mode:"winter",days:DOW_ALL.slice()}))}else{tpData.entries.push(normSwitchEntry(tpKind,{time:"08:00",action:tpKind==="shutter"?"down":"off",days:DOW_ALL.slice()}))}renderTpRows()};tpSave.onclick=saveTProfile;tpClose.onclick=closeTProfile;tpModal.onclick=e=>{if(e.target===tpModal)closeTProfile()};init();
</script>
</body>
</html>
